import pandas as pd
import pytest

import src.evaluation as evaluation


# __get_dcg
def test_get_dcg_happy():
    series_in_values = [33919, 5, 1]
    series_in_index = ['id', 'rating', 'rank']

    series_in = pd.Series(series_in_values, index=series_in_index)

    output_true = 5.0

    # Compute test output
    output_test = evaluation.__get_dcg(series_in, rating_col='rating', rank_col='rank')

    assert output_test == output_true


def test_get_dcg_unhappy():
    series_in = 'not a series'
    with pytest.raises(TypeError):
        evaluation.__get_dcg(series_in, rating_col='rating', rank_col='rank')


# __get_idcg
def test_get_idcg_happy():
    df_in_values = [[33919, 5, 1],
                    [86125, 5, 1],
                    [80964, 0, 3],
                    [273998, 0, 3],
                    [133397, 0, 3],
                    [189389, 0, 3],
                    [242922, 0, 3],
                    [84289, 0, 3],
                    [188327, 0, 3],
                    [34110, 0, 3],
                    [299148, 0, 3]]

    df_in_columns = ['id', 'rating', 'rank']

    df_in_index = list(range(0, 11))

    df_in = pd.DataFrame(df_in_values, columns=df_in_columns, index=df_in_index)

    output_true = 10.0

    # Compute test output
    output_test = evaluation.__get_idcg(df_in, 'rating', 'rank', 10)

    assert output_test == output_true


def test_get_idcg_unhappy():
    df_in = 'not a dataframe'
    with pytest.raises(AttributeError):
        evaluation.__get_idcg(df_in, 'rating', 'rank', 10)


# __get_info
def test_get_info_happy():
    list_in = [[56103, 5],
               [59911, 5],
               [220475, 5]]

    df_in_values = [['olive garden fried mozzarella', 59911, -0.002126601629670684,
                     0.03768000234899039, -0.28179326298112983, -0.8508247037275356,
                     -0.7287902029839678, 1.8616647924225949, 1.5279601928837094,
                     1.639090793746917, -0.6543916710088926, 1.750239120389291,
                     -0.4631609213235457, -0.4293434457615551, -0.5002729746998658,
                     -0.4296532983315187, -0.4908663821138817, -0.3571905059406881,
                     -0.38427991971436704, -0.3193815890823397, -0.30999969970353625,
                     -0.2845728385228276, -0.2825933069051732, -0.29085635928783365,
                     -0.2840561898341468, 0.6424064493930104, 0.9089312216785173,
                     -0.765485326326796, -0.6701164442803513, -0.5646923341686837,
                     -0.5479576413498478, 1.9481396948020788, -0.4784344550271695,
                     -0.4578405182055043, 2.2699788918858848, 2.3392372831916903,
                     2.3271067838806534, 2.452697320598244, -0.3927717170608427,
                     -0.3877053259757864, 2.597416736647708, -0.3632638243630567,
                     2.7429589588936376, 2.8018443749789066, -0.3465245524637813,
                     0.1631488532049153, 0.12946330582408244, -0.0848063159149068,
                     0.2573615926963562, 0.6565873245567702, 0.364972068792079,
                     0.04303023073722027, 8],
                    ['peanut butter noodles', 220475, -0.0021243846812274304,
                     -0.29566385481285834, 0.2528326026937516, -0.8508247037275356,
                     1.3721369962241363, -0.5371536294128945, 1.5279601928837094,
                     -0.6100943302317177, 1.5281368090432357, -0.5713505019688842,
                     -0.4631609213235457, 2.3291376865582127, -0.5002729746998658,
                     -0.4296532983315187, -0.4908663821138817, -0.3571905059406881,
                     -0.38427991971436704, -0.3193815890823397, -0.30999969970353625,
                     -0.2845728385228276, -0.2825933069051732, -0.29085635928783365,
                     3.5204302380591472, 0.6424064493930104, 0.9089312216785173,
                     1.3063607695767732, 1.4922779593536404, -0.5646923341686837,
                     -0.5479576413498478, -0.5133102121311659, -0.4784344550271695,
                     2.184166669912653, 2.2699788918858848, -0.4274897665086737,
                     2.3271067838806534, 2.452697320598244, -0.3927717170608427,
                     -0.3877053259757864, -0.3849979042218021, 2.752820217519294,
                     2.7429589588936376, 2.8018443749789066, -0.3465245524637813,
                     -0.07855659065240722, -0.2436077769791739, -0.05507017212019997,
                     0.05260330833848252, -0.0786624585539517, -0.3622029771695773,
                     0.030906472239980956, 8],
                    ['roasted brussels sprouts', 56103, -0.0021177338358976685,
                     -0.6290077119747072, -1.3510449943308926, -0.8508247037275356,
                     -0.7287902029839678, -0.5371536294128945, -0.6544673118170091,
                     -0.6100943302317177, -0.6543916710088926, -0.5713505019688842,
                     2.159076800223912, -0.4293434457615551, -0.5002729746998658,
                     -0.4296532983315187, -0.4908663821138817, -0.3571905059406881,
                     -0.38427991971436704, -0.3193815890823397, -0.30999969970353625,
                     -0.2845728385228276, -0.2825933069051732, -0.29085635928783365,
                     -0.2840561898341468, 0.6424064493930104, 0.9089312216785173,
                     1.3063607695767732, -0.6701164442803513, -0.5646923341686837,
                     1.824958581719171, -0.5133102121311659, -0.4784344550271695,
                     -0.4578405182055043, -0.4405327307555737, 2.3392372831916903,
                     -0.4297181405369001, -0.4077143932933752, -0.3927717170608427,
                     2.5792784700163067, -0.3849979042218021, -0.3632638243630567,
                     -0.3645698003455896, -0.3569077600919676, -0.3465245524637813,
                     -0.31021887202258336, -0.320794897559158, -0.09471836384647576,
                     -0.15973861618079388, -0.5061332626880923, -0.4134124874485672,
                     -0.16307366371584814, 9]]
    df_in_index = [1, 2, 3]
    df_in_columns = ['name', 'id', 'minutes', 'n_steps', 'n_ingredients', 'pepper', 'onion',
                     'cheese', 'garlic', 'egg', 'butter', 'flour', 'lemon', 'chicken',
                     'milk', 'tomato', 'cream', 'baking', 'vanilla', 'cinnamon', 'parsley',
                     'apple', 'beef', 'potato', 'chili', 'dietary', 'easy',
                     'low-in-something', 'main-dish', 'meat', 'vegetables', 'north-american',
                     'desserts', 'healthy', 'dinner-party', 'vegetarian', 'beginner-cook',
                     'inexpensive', 'fruit', 'oven', 'eggs-dairy', 'pasta-rice-and-grains',
                     'kid-friendly', 'comfort-food', 'european', 'calories', 'total_fat',
                     'sugar', 'sodium', 'protein', 'saturated_fat', 'carbs', 'cluster']
    df_in = pd.DataFrame(df_in_values, columns=df_in_columns, index=df_in_index)

    output_true = 59911

    df_true = pd.DataFrame([['olive garden fried mozzarella', 59911, -0.002126601629670684,
                             0.03768000234899039, -0.28179326298112983, -0.8508247037275356,
                             -0.7287902029839678, 1.8616647924225949, 1.5279601928837094,
                             1.639090793746917, -0.6543916710088926, 1.750239120389291,
                             -0.4631609213235457, -0.4293434457615551, -0.5002729746998658,
                             -0.4296532983315187, -0.4908663821138817, -0.3571905059406881,
                             -0.38427991971436704, -0.3193815890823397, -0.30999969970353625,
                             -0.2845728385228276, -0.2825933069051732, -0.29085635928783365,
                             -0.2840561898341468, 0.6424064493930104, 0.9089312216785173,
                             -0.765485326326796, -0.6701164442803513, -0.5646923341686837,
                             -0.5479576413498478, 1.9481396948020788, -0.4784344550271695,
                             -0.4578405182055043, 2.2699788918858848, 2.3392372831916903,
                             2.3271067838806534, 2.452697320598244, -0.3927717170608427,
                             -0.3877053259757864, 2.597416736647708, -0.3632638243630567,
                             2.7429589588936376, 2.8018443749789066, -0.3465245524637813,
                             0.1631488532049153, 0.12946330582408244, -0.0848063159149068,
                             0.2573615926963562, 0.6565873245567702, 0.364972068792079,
                             0.04303023073722027, 8],
                            ['peanut butter noodles', 220475, -0.0021243846812274304,
                             -0.29566385481285834, 0.2528326026937516, -0.8508247037275356,
                             1.3721369962241363, -0.5371536294128945, 1.5279601928837094,
                             -0.6100943302317177, 1.5281368090432357, -0.5713505019688842,
                             -0.4631609213235457, 2.3291376865582127, -0.5002729746998658,
                             -0.4296532983315187, -0.4908663821138817, -0.3571905059406881,
                             -0.38427991971436704, -0.3193815890823397, -0.30999969970353625,
                             -0.2845728385228276, -0.2825933069051732, -0.29085635928783365,
                             3.5204302380591472, 0.6424064493930104, 0.9089312216785173,
                             1.3063607695767732, 1.4922779593536404, -0.5646923341686837,
                             -0.5479576413498478, -0.5133102121311659, -0.4784344550271695,
                             2.184166669912653, 2.2699788918858848, -0.4274897665086737,
                             2.3271067838806534, 2.452697320598244, -0.3927717170608427,
                             -0.3877053259757864, -0.3849979042218021, 2.752820217519294,
                             2.7429589588936376, 2.8018443749789066, -0.3465245524637813,
                             -0.07855659065240722, -0.2436077769791739, -0.05507017212019997,
                             0.05260330833848252, -0.0786624585539517, -0.3622029771695773,
                             0.030906472239980956, 8],
                            ['roasted brussels sprouts', 56103, -0.0021177338358976685,
                             -0.6290077119747072, -1.3510449943308926, -0.8508247037275356,
                             -0.7287902029839678, -0.5371536294128945, -0.6544673118170091,
                             -0.6100943302317177, -0.6543916710088926, -0.5713505019688842,
                             2.159076800223912, -0.4293434457615551, -0.5002729746998658,
                             -0.4296532983315187, -0.4908663821138817, -0.3571905059406881,
                             -0.38427991971436704, -0.3193815890823397, -0.30999969970353625,
                             -0.2845728385228276, -0.2825933069051732, -0.29085635928783365,
                             -0.2840561898341468, 0.6424064493930104, 0.9089312216785173,
                             1.3063607695767732, -0.6701164442803513, -0.5646923341686837,
                             1.824958581719171, -0.5133102121311659, -0.4784344550271695,
                             -0.4578405182055043, -0.4405327307555737, 2.3392372831916903,
                             -0.4297181405369001, -0.4077143932933752, -0.3927717170608427,
                             2.5792784700163067, -0.3849979042218021, -0.3632638243630567,
                             -0.3645698003455896, -0.3569077600919676, -0.3465245524637813,
                             -0.31021887202258336, -0.320794897559158, -0.09471836384647576,
                             -0.15973861618079388, -0.5061332626880923, -0.4134124874485672,
                             -0.16307366371584814, 9]],
                           columns=['name', 'id', 'minutes', 'n_steps', 'n_ingredients', 'pepper', 'onion',
                                    'cheese', 'garlic', 'egg', 'butter', 'flour', 'lemon', 'chicken',
                                    'milk', 'tomato', 'cream', 'baking', 'vanilla', 'cinnamon', 'parsley',
                                    'apple', 'beef', 'potato', 'chili', 'dietary', 'easy',
                                    'low-in-something', 'main-dish', 'meat', 'vegetables', 'north-american',
                                    'desserts', 'healthy', 'dinner-party', 'vegetarian', 'beginner-cook',
                                    'inexpensive', 'fruit', 'oven', 'eggs-dairy', 'pasta-rice-and-grains',
                                    'kid-friendly', 'comfort-food', 'european', 'calories', 'total_fat',
                                    'sugar', 'sodium', 'protein', 'saturated_fat', 'carbs', 'cluster'], index=[1, 2, 3])

    df2_true = pd.DataFrame([[56103, 5, 1],
                             [59911, 5, 1],
                             [220475, 5, 1]], columns=['id', 'rating', 'rank'], index=[0, 1, 2])

    # compute test output
    output_test, df_test, df2_test = evaluation.__get_info(list_in, df_in, 'id')

    assert output_test == output_true
    pd.testing.assert_frame_equal(df_test, df_true)
    pd.testing.assert_frame_equal(df2_test, df2_true)


def test_get_info_unhappy():
    list_in = 'not a list'
    df_in = 'not a dataframe'
    with pytest.raises(IndexError):
        evaluation.__get_info(list_in, df_in, 'id')


# evaluation
def test_evaluation_happy():
    df1_in = pd.DataFrame([['[[59911, 5], [56103, 3], [220475, 1]]', 3],
                           ['[[59911, 1], [56103, 2], [220475, 1]]', 3]], index=[0, 1], columns=['list', 'count'])
    df2_in_values = [['olive garden fried mozzarella', 59911, -0.002126601629670684,
                      0.03768000234899039, -0.28179326298112983, -0.8508247037275356,
                      -0.7287902029839678, 1.8616647924225949, 1.5279601928837094,
                      1.639090793746917, -0.6543916710088926, 1.750239120389291,
                      -0.4631609213235457, -0.4293434457615551, -0.5002729746998658,
                      -0.4296532983315187, -0.4908663821138817, -0.3571905059406881,
                      -0.38427991971436704, -0.3193815890823397, -0.30999969970353625,
                      -0.2845728385228276, -0.2825933069051732, -0.29085635928783365,
                      -0.2840561898341468, 0.6424064493930104, 0.9089312216785173,
                      -0.765485326326796, -0.6701164442803513, -0.5646923341686837,
                      -0.5479576413498478, 1.9481396948020788, -0.4784344550271695,
                      -0.4578405182055043, 2.2699788918858848, 2.3392372831916903,
                      2.3271067838806534, 2.452697320598244, -0.3927717170608427,
                      -0.3877053259757864, 2.597416736647708, -0.3632638243630567,
                      2.7429589588936376, 2.8018443749789066, -0.3465245524637813,
                      0.1631488532049153, 0.12946330582408244, -0.0848063159149068,
                      0.2573615926963562, 0.6565873245567702, 0.364972068792079,
                      0.04303023073722027, 8],
                     ['peanut butter noodles', 220475, -0.0021243846812274304,
                      -0.29566385481285834, 0.2528326026937516, -0.8508247037275356,
                      1.3721369962241363, -0.5371536294128945, 1.5279601928837094,
                      -0.6100943302317177, 1.5281368090432357, -0.5713505019688842,
                      -0.4631609213235457, 2.3291376865582127, -0.5002729746998658,
                      -0.4296532983315187, -0.4908663821138817, -0.3571905059406881,
                      -0.38427991971436704, -0.3193815890823397, -0.30999969970353625,
                      -0.2845728385228276, -0.2825933069051732, -0.29085635928783365,
                      3.5204302380591472, 0.6424064493930104, 0.9089312216785173,
                      1.3063607695767732, 1.4922779593536404, -0.5646923341686837,
                      -0.5479576413498478, -0.5133102121311659, -0.4784344550271695,
                      2.184166669912653, 2.2699788918858848, -0.4274897665086737,
                      2.3271067838806534, 2.452697320598244, -0.3927717170608427,
                      -0.3877053259757864, -0.3849979042218021, 2.752820217519294,
                      2.7429589588936376, 2.8018443749789066, -0.3465245524637813,
                      -0.07855659065240722, -0.2436077769791739, -0.05507017212019997,
                      0.05260330833848252, -0.0786624585539517, -0.3622029771695773,
                      0.030906472239980956, 8],
                     ['roasted brussels sprouts', 56103, -0.0021177338358976685,
                      -0.6290077119747072, -1.3510449943308926, -0.8508247037275356,
                      -0.7287902029839678, -0.5371536294128945, -0.6544673118170091,
                      -0.6100943302317177, -0.6543916710088926, -0.5713505019688842,
                      2.159076800223912, -0.4293434457615551, -0.5002729746998658,
                      -0.4296532983315187, -0.4908663821138817, -0.3571905059406881,
                      -0.38427991971436704, -0.3193815890823397, -0.30999969970353625,
                      -0.2845728385228276, -0.2825933069051732, -0.29085635928783365,
                      -0.2840561898341468, 0.6424064493930104, 0.9089312216785173,
                      1.3063607695767732, -0.6701164442803513, -0.5646923341686837,
                      1.824958581719171, -0.5133102121311659, -0.4784344550271695,
                      -0.4578405182055043, -0.4405327307555737, 2.3392372831916903,
                      -0.4297181405369001, -0.4077143932933752, -0.3927717170608427,
                      2.5792784700163067, -0.3849979042218021, -0.3632638243630567,
                      -0.3645698003455896, -0.3569077600919676, -0.3465245524637813,
                      -0.31021887202258336, -0.320794897559158, -0.09471836384647576,
                      -0.15973861618079388, -0.5061332626880923, -0.4134124874485672,
                      -0.16307366371584814, 9]]
    df2_in_index = [1, 2, 3]
    df2_in_columns = ['name', 'id', 'minutes', 'n_steps', 'n_ingredients', 'pepper', 'onion',
                      'cheese', 'garlic', 'egg', 'butter', 'flour', 'lemon', 'chicken',
                      'milk', 'tomato', 'cream', 'baking', 'vanilla', 'cinnamon', 'parsley',
                      'apple', 'beef', 'potato', 'chili', 'dietary', 'easy',
                      'low-in-something', 'main-dish', 'meat', 'vegetables', 'north-american',
                      'desserts', 'healthy', 'dinner-party', 'vegetarian', 'beginner-cook',
                      'inexpensive', 'fruit', 'oven', 'eggs-dairy', 'pasta-rice-and-grains',
                      'kid-friendly', 'comfort-food', 'european', 'calories', 'total_fat',
                      'sugar', 'sodium', 'protein', 'saturated_fat', 'carbs', 'cluster']
    df2_in = pd.DataFrame(df2_in_values, columns=df2_in_columns, index=df2_in_index)

    output_true = 0.25354933810238667

    # calculate test output
    output_test = evaluation.evaluation(df1_in, df2_in, clust_col='cluster', list_col='list', rating_col='rating',
                                        rank_col='rank', id_col="id", top_n=2)

    assert output_test == output_true


def test_evaluation_unhappy():
    df1_in = 'not df'
    df2_in = 'also not df'

    with pytest.raises(TypeError):
        evaluation.evaluation(df1_in, df2_in, clust_col='cluster', list_col='list', rating_col='rating',
                              rank_col='rank', id_col="id", top_n=2)
